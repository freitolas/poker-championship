<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Curupira's Head Poker Championship 2026</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIFBva2VyIENoaXAgLS0+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzAiIGZpbGw9IiNGRjk4MDAiIHN0cm9rZT0iI0Q4NDMxNSIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0ZGRDc0MCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI0Q4NDMxNSIgc3Ryb2tlLXdpZHRoPSIxIi8+CiAgCiAgPCEtLSBDZW50ZXIgVGV4dCAtLT4KICA8dGV4dCB4PSIzMiIgeT0iMzgiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj41PC90ZXh0Pgo8L3N2Zz4K">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      background: url('background.svg'), linear-gradient(135deg, #fff7e1 0%, #ffe0b2 100%);
      background-size: 512px 512px, auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #7a4800; display: flex; min-height: 100vh;
    }
    .main-content { flex: 3; padding: 20px; min-width: 500px; overflow-y: auto; }
    h1 { text-align: center; color: #e65100; font-size: 2.2rem; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); position: relative; }
    h1::before { content: "‚ô†"; position: absolute; left: -40px; top: 50%; transform: translateY(-50%); color: #d84315; font-size: 1.8rem; }
    h1::after { content: "‚ô•"; position: absolute; right: -40px; top: 50%; transform: translateY(-50%); color: #d84315; font-size: 1.8rem; }
    
    .game-info { background: linear-gradient(90deg, #ffd740 0%, #ffa726 100%); padding: 15px; border-radius: 10px; text-align: center; color: #d84315; font-weight: 700; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2); }
    .player-setup { background: #fff3e0; padding: 20px; border: 2px solid #ffa726; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1); }
    .player-setup h3 { margin-top: 0; color: #e65100; font-size: 1.4rem; }
    
    .major-controls { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; background: #ffe0b2; padding: 10px; border-radius: 6px; border: 1px solid #ffcc80; }
    .player-input-row { display: flex; gap: 12px; margin-bottom: 15px; align-items: center; }
    #playerNameInput, #playerSelect, #tournamentNameSelect { flex: 1; padding: 10px; border: 2px solid #ffa726; border-radius: 6px; font-size: 16px; outline: none; }
    
    button { padding: 10px 16px; border: 2px solid #ffa726; border-radius: 6px; background: #ffb74d; color: #7a4800; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
    button:hover:not(:disabled) { background: #ff9800; color: #fff; transform: translateY(-1px); }
    button:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; border-color: #bdbdbd; }
    .rebuy-btn { background: #f44336 !important; color: white !important; border-color: #d32f2f !important; }
    .addon-btn { background: #2196f3 !important; color: white !important; border-color: #1976d2 !important; }
    
    .action-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    
    table { width: 100%; border-collapse: collapse; background: #fff3e0; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15); margin-bottom: 20px; }
    th, td { padding: 12px 8px; text-align: center; font-weight: 600; border-bottom: 1px solid #eee; }
    thead { background: linear-gradient(90deg, #ff9800 0%, #fb8c00 100%); color: white; }
    tbody tr:nth-child(odd) { background: #fff9e5; }
    tbody tr.eliminated { background: #ffcdd2 !important; color: #c62828; opacity: 0.8; }
    
    .timer-panel { flex: 1; background: linear-gradient(135deg, #ffecb3 0%, #ffd54f 100%); border-left: 7px solid #ffa726; padding: 25px; display: flex; flex-direction: column; align-items: center; height: 100vh; position: sticky; top: 0; overflow-y: auto; }
    .timer-header { font-size: 2.4rem; font-weight: 900; color: #e65100; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); position: relative; }
    .round-info { width: 100%; background: #ffe0b2; border-radius: 12px; padding: 20px; font-size: 1.4rem; font-weight: 700; text-align: center; color: #e65100; margin-bottom: 25px; }
    .time-remaining { font-size: 3.8rem; font-weight: 900; background: #ffd54f; color: #e65100; border-radius: 15px; padding: 20px 35px; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.25); margin: 20px 0 30px; text-align: center; min-width: 200px; font-family: 'Segoe UI', sans-serif; }
    
    .dashboard-tabs { display: flex; border-bottom: 3px solid #ffa726; margin-bottom: 20px; border-radius: 10px 10px 0 0; overflow: hidden; }
    .dashboard-tab { flex: 1; padding: 15px 20px; background: #ffe0b2; color: #e65100; border: none; font-weight: 700; cursor: pointer; border-right: 2px solid #ffa726; }
    .dashboard-tab.active { background: #ff9800; color: white; }
    .dashboard-tab-content { background: #fff3e0; padding: 25px; border-radius: 0 0 10px 10px; min-height: 400px; }
    
    /* Title Cards */
    .titles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .title-card { background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); border: 3px solid #ffa726; border-radius: 15px; padding: 20px; text-align: center; }
    .title-card-emoji { font-size: 3rem; display: block; margin-bottom: 10px; }
    .title-card-holder { font-size: 1.8rem; font-weight: 900; color: #d84315; }
    
    .status-message { background: #e8f5e8; border: 2px solid #4caf50; color: #2e7d32; padding: 12px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: 600; opacity: 0; transition: opacity 0.3s ease; }
    .status-message.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="main-content">
    <h1>Curupira's Head Poker Championship 2026</h1>
    
    <div class="game-info" id="gameInfoDisplay">
      Buy-in: ¬£5 per stack | 1st: 80% | 2nd: 20% | House Fee: ¬£5
    </div>
    
    <div class="status-message" id="statusMessage"></div>
    
    <div class="player-setup">
      <div class="major-controls">
        <div>
            <label style="font-weight:bold; color:#e65100; margin-right:5px;">Major Mode:</label>
            <input type="checkbox" id="majorToggle" onchange="updateGameSettings()">
        </div>
        <select id="tournamentNameSelect" style="flex:1;" onchange="handleTournamentSelect()">
          <option value="Regular Game">Regular Game</option>
          <option value="The Dry Jan Finishers Cup">The Dry Jan Finishers Cup (Major)</option>
          <option value="The Equinox All-In">The Equinox All-In (Major)</option>
          <option value="Back to School Bounty Championship">Back to School Bounty Championship (Major)</option>
          <option value="The Grand Finale">The Grand Finale (Major)</option>
        </select>
      </div>

      <h3>Add Players</h3>
      <div class="player-input-row">
        <select id="playerSelect">
          <option value="">Select a player...</option>
        </select>
        <input type="text" id="playerNameInput" placeholder="Or enter new player name..." />
        <button onclick="addPlayer()">Add Player</button>
      </div>
      
      <div class="setup-buttons">
        <button onclick="startTournament()" id="startBtn">Start Tournament</button>
        <button onclick="endTournament()" id="endBtn" disabled>End Tournament</button>
        <button onclick="clearPlayers()">Clear All Players</button>
        <button onclick="undoLastAction()" id="undoBtn" disabled>Undo</button>
      </div>
      
      <div id="playerCount">Players: 0 | Prize Pot: ¬£0 | House Fee: ¬£5</div>
      
      <div class="action-buttons">
        <button onclick="signInAndExport()" id="exportBtn" disabled>Save Tournament Data</button>
        <button onclick="signInAndLoadDashboard()" id="loadDashboardBtn">Load Championship Dashboard</button>
      </div>
    </div>
    
    <table id="playerTable">
      <thead>
        <tr><th>Player</th><th>Stacks</th><th>Total Paid</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody id="playerTableBody"></tbody>
    </table>
    
    <div id="prizeResults"></div>
    <div class="charts-section" id="chartsSection"></div>
  </div>
  
  <div class="timer-panel">
    <div class="timer-header">ROUND TIMER</div>
    <div id="roundInfo" class="round-info"></div>
    <div id="timeRemaining" class="time-remaining">00:05</div>
    
    <div class="timer-controls">
      <button id="timerStartBtn" onclick="startTimer()">START</button>
      <button id="timerPauseBtn" onclick="pauseTimer()" disabled>PAUSE</button>
      <button id="timerResetBtn" onclick="resetTimer()">RESET</button>
      <button id="timerSkipBtn" onclick="skipRound()">SKIP ROUND</button>
    </div>
    
    <div id="breakNotice" class="break-notice" style="display:none; background:#bbdefb; padding:15px; margin:15px 0; border-radius:10px; color:#0d47a1; font-weight:700; text-align:center;">
      BREAK TIME! - Add-ons available
    </div>
    
    <div class="prize-info">
      <div><strong>Current Prize Pool: ¬£<span id="currentPrizePool">0</span></strong></div>
      <div>1st Place: ¬£<span id="firstPrize">0</span></div>
      <div>2nd Place: ¬£<span id="secondPrize">0</span></div>
    </div>
    
    <audio id="roundAlarm" preload="auto">
      <source src="alarm.mp3" type="audio/mpeg">
      <source src="alarm.mp3" type="audio/mp3">
    </audio>
  </div>

  <script>
    // === CONFIGURATION ===
    const CLIENT_ID = '341648594146-a9httcsv8e29vr4ehcup08qlpaak5u8a.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1fZWOlbf95Xqg4AnsEm9ga8x1ENrZ_K_0EEF3sEZGz2Y';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    // === TOURNAMENT STRUCTURE ===
    const rounds = [
      { name: "Test Round", sb: 0, bb: 0, duration: 5, isTest: true },
      { name: "Round 1", sb: 5, bb: 10, duration: 20 },
      { name: "Round 2", sb: 10, bb: 20, duration: 20 },
      { name: "Round 3", sb: 20, bb: 40, duration: 20 },
      { name: "Round 4", sb: 40, bb: 80, duration: 20 },
      { name: "Break + Add-On", sb: 0, bb: 0, duration: 30, isBreak: true },
      { name: "Round 5", sb: 50, bb: 100, duration: 20 },
      { name: "Round 6", sb: 100, bb: 200, duration: 20 },
      { name: "Round 7", sb: 200, bb: 400, duration: 20 },
      { name: "Round 8", sb: 400, bb: 800, duration: 20 },
      { name: "Round 9", sb: 1000, bb: 2000, duration: 20 },
      { name: "Round 10", sb: 2000, bb: 4000, duration: 20 },
      { name: "Round 11", sb: 4000, bb: 8000, duration: 20 },
      { name: "Round 12", sb: 8000, bb: 16000, duration: 20 },
      { name: "Round 13", sb: 16000, bb: 32000, duration: 20 },
      { name: "Round 14", sb: 32000, bb: 64000, duration: 20 },
      { name: "Round 15", sb: 64000, bb: 128000, duration: 20 },
      { name: "Round 16", sb: 125000, bb: 250000, duration: 20 },
      { name: "Round 17", sb: 250000, bb: 500000, duration: 20 },
      { name: "Round 18", sb: 500000, bb: 1000000, duration: 20 }
    ];

    const regularPlayers = [
      'Andre', 'Craig', 'Dale', 'Declan', 'Elton', 'Graham', 'Jacques', 'James', 'Lachy', 'Luciano', 'Malzo', 'Matt', 'Nick', 'Rafa', 'Rhys', 'Roberto'
    ].sort();

    // === GLOBAL STATE ===
    let players = [];
    let customPlayers = [];
    let currentRound = 0;
    let timer = null;
    let timeLeft = 0;
    let tournamentStarted = false;
    let tournamentEnded = false;
    let timerRunning = false;
    let googleApiReady = false;
    let actionHistory = [];

    // === INITIALIZATION ===
    window.onload = function() {
        populatePlayerDropdown();
        updateRoundDisplay();
        updateGameSettings();
        if(typeof gapi !== 'undefined') {
            gapi.load('client:auth2', initClient);
        }
    };

    function handleTournamentSelect() {
        const sel = document.getElementById('tournamentNameSelect').value;
        const majorToggle = document.getElementById('majorToggle');
        if(sel.includes("Major") || sel.includes("Cup") || sel.includes("Finale") || sel.includes("Bounty")) {
            majorToggle.checked = true;
        } else {
            majorToggle.checked = false;
        }
        updateGameSettings();
    }

    function updateGameSettings() {
        const isMajor = document.getElementById('majorToggle').checked;
        const buyIn = isMajor ? 10 : 5;
        document.getElementById('gameInfoDisplay').innerHTML = 
            `MODE: ${isMajor ? 'üèÜ MAJOR (2x Points/Buy-in)' : 'Standard'} | Buy-in: ¬£${buyIn} | 1st: 80% | 2nd: 20% | House Fee: ¬£5`;
        updatePrizeInfo();
    }

    function populatePlayerDropdown() {
      const select = document.getElementById('playerSelect');
      if(!select) return;
      select.innerHTML = '<option value="">Select a player...</option>';
      const all = [...new Set([...regularPlayers, ...customPlayers])].sort();
      all.forEach(p => select.add(new Option(p, p)));
    }

    // === PLAYER ACTIONS ===
    window.addPlayer = function() {
        if(tournamentStarted) {
            const breakIdx = rounds.findIndex(r => r.isBreak);
            if(breakIdx !== -1 && currentRound > breakIdx) return showMessage("Late registration closed", true);
            if(breakIdx === -1) return showMessage("Game started - no late reg", true);
        }
        
        const name = (document.getElementById('playerSelect').value || document.getElementById('playerNameInput').value).trim();
        if(!name) return showMessage("Enter a name", true);
        if(players.some(p => p.name === name)) return showMessage("Player exists", true);
        
        if(!regularPlayers.includes(name) && !customPlayers.includes(name)) {
            customPlayers.push(name);
            populatePlayerDropdown();
        }

        const isMajor = document.getElementById('majorToggle').checked;
        const cost = isMajor ? 10 : 5;
        players.push({ name, stacks:1, totalPaid:cost, eliminated:false, hasAddon:false, eliminationTime:null, rebuyEliminations:[] });
        
        document.getElementById('playerNameInput').value = '';
        updatePlayerTable();
        showMessage(`${name} added`);
    }

    window.removePlayer = function(i) {
        if(tournamentStarted) return showMessage("Cannot remove during game", true);
        players.splice(i, 1);
        updatePlayerTable();
    }

    window.eliminatePlayer = function(index) {
        const p = players[index];
        const killers = players.filter(pl => pl.name !== p.name && !pl.eliminated).map(pl => pl.name);
        
        const options = killers.map(k => `<option value="${k}">${k}</option>`).join('');
        
        const dialog = document.createElement('div');
        dialog.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:3px solid #ffa726; z-index:1000; border-radius:10px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.3);";
        dialog.innerHTML = `
            <h3 style="color:#e65100; margin-top:0;">Eliminate ${p.name}</h3>
            <p>Who eliminated them?</p>
            <select id="killerSelect" style="padding:5px; font-size:16px;">
                <option value="N/A">N/A (Self/Unknown)</option>
                ${options}
            </select>
            <div style="margin-top:15px;">
                <button onclick="confirmEliminate(${index})" style="background:#f44336; color:white;">Confirm</button>
                <button onclick="document.body.removeChild(this.parentNode.parentNode)">Cancel</button>
            </div>
        `;
        document.body.appendChild(dialog);
    }

    window.confirmEliminate = function(index) {
        try {
            const p = players[index];
            const killer = document.getElementById('killerSelect').value;
            
            p.eliminated = true;
            p.eliminatedBy = killer;
            p.eliminationTime = Date.now();
            recordAction('eliminate', { name: p.name });
            
            // Remove dialog
            const dialog = document.getElementById('killerSelect').parentNode;
            document.body.removeChild(dialog);
            
            updatePlayerTable();
            checkForWinner();
        } catch(e) {
            alert("Error confirming elimination: " + e.message);
        }
    }

    window.rebuyPlayer = function(index) {
        try {
            const p = players[index];
            const toggle = document.getElementById('majorToggle');
            const cost = (toggle && toggle.checked) ? 10 : 5;
            
            recordAction('rebuy', { name: p.name });
            if(p.eliminated) {
                p.rebuyEliminations.push({ eliminatedBy: p.eliminatedBy, timestamp: p.eliminationTime });
            }
            p.eliminated = false;
            p.stacks++;
            p.totalPaid += cost;
            updatePlayerTable();
            showMessage(`${p.name} rebought`);
        } catch(e) {
            alert("Rebuy error: " + e.message);
        }
    }

    window.addonPlayer = function(index) {
        try {
            const p = players[index];
            if(p.hasAddon) return alert("Already added on");
            
            const toggle = document.getElementById('majorToggle');
            const cost = (toggle && toggle.checked) ? 10 : 5;
            
            recordAction('addon', { name: p.name });
            p.stacks++;
            p.totalPaid += cost;
            p.hasAddon = true;
            updatePlayerTable();
            showMessage(`${p.name} added on`);
        } catch(e) {
            alert("Addon error: " + e.message);
        }
    }

    function updatePlayerTable() {
        const tbody = document.getElementById('playerTableBody');
        tbody.innerHTML = '';
        const toggle = document.getElementById('majorToggle');
        const cost = (toggle && toggle.checked) ? 10 : 5;
        
        const active = players.filter(p => !p.eliminated);
        const hasWinner = tournamentStarted && active.length === 1;
        const breakIdx = rounds.findIndex(r => r.isBreak);
        const isBreakRound = rounds[currentRound].isBreak;

        players.forEach((p, i) => {
            let actions = '';
            if(!tournamentStarted) {
                actions = `<button onclick="removePlayer(${i})">Remove</button>`;
            } else if (!tournamentEnded) {
                if(hasWinner && !p.eliminated) {
                    actions = `<strong>üèÜ WINNER</strong>`;
                } else if (!p.eliminated) {
                    actions = `<button onclick="eliminatePlayer(${i})">Eliminate</button>`;
                } else {
                    // Rebuy allowed if before break finishes
                    if(currentRound <= breakIdx) {
                        actions += `<button class="rebuy-btn" onclick="rebuyPlayer(${i})">Rebuy ¬£${cost}</button> `;
                    }
                }
                
                // Addon logic - strict check
                if(isBreakRound && !p.hasAddon && !p.eliminated) {
                     actions += `<button class="addon-btn" onclick="addonPlayer(${i})">Addon ¬£${cost}</button>`;
                }
            }

            const tr = document.createElement('tr');
            if(p.eliminated) tr.className = 'eliminated';
            tr.innerHTML = `
                <td>${p.name}</td>
                <td>${p.stacks}</td>
                <td>¬£${p.totalPaid}</td>
                <td>${p.eliminated ? (p.eliminatedBy && p.eliminatedBy!=='N/A' ? 'Out by '+p.eliminatedBy : 'Out') : 'Active'}</td>
                <td>${actions}</td>
            `;
            tbody.appendChild(tr);
        });
        updatePrizeInfo();
    }

    function checkForWinner() {
        const active = players.filter(p => !p.eliminated);
        if(tournamentStarted && !tournamentEnded && active.length === 1) {
            alert(`üèÜ ${active[0].name} Wins!`);
            clearInterval(timer);
            timerRunning = false;
            updatePlayerTable();
        }
    }

    function updatePrizeInfo() {
        const total = players.reduce((acc, p) => acc + p.totalPaid, 0);
        const house = total > 100 ? 10 : 5;
        const pool = Math.max(0, total - house);
        const p1 = Math.round((pool * 0.8)/5)*5;
        const p2 = Math.round((pool * 0.2)/5)*5;
        
        document.getElementById('playerCount').innerText = `Players: ${players.length} | Prize Pot: ¬£${pool} | House Fee: ¬£${house}`;
        document.getElementById('currentPrizePool').innerText = pool;
        document.getElementById('firstPrize').innerText = p1;
        document.getElementById('secondPrize').innerText = p2;
    }

    // === TIMER ===
    function updateRoundDisplay() {
        const r = rounds[currentRound];
        document.getElementById('roundInfo').innerHTML = `${r.name}<br>${r.isBreak ? "BREAK" : r.sb + " / " + r.bb}`;
        
        if(!timerRunning) {
            timeLeft = r.duration * (r.isTest ? 1 : 60);
            document.getElementById('timeRemaining').innerText = formatTime(timeLeft);
        }
        
        const isBreak = !!r.isBreak;
        document.getElementById('breakNotice').style.display = isBreak ? 'block' : 'none';
        
        // FORCE TABLE UPDATE to show Addon buttons
        if(tournamentStarted) updatePlayerTable();
    }

    window.startTimer = function() {
        if(timerRunning) return;
        timerRunning = true;
        document.getElementById('timerStartBtn').disabled = true;
        document.getElementById('timerPauseBtn').disabled = false;
        timer = setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                document.getElementById('timeRemaining').innerText = formatTime(timeLeft);
            } else {
                document.getElementById('roundAlarm').play();
                clearInterval(timer);
                timerRunning = false;
                if(currentRound < rounds.length - 1) {
                    alert("Round Ended!");
                    currentRound++;
                    updateRoundDisplay();
                    startTimer();
                }
            }
        }, 1000);
    }

    window.pauseTimer = function() {
        clearInterval(timer);
        timerRunning = false;
        document.getElementById('timerStartBtn').disabled = false;
        document.getElementById('timerPauseBtn').disabled = true;
    }

    window.resetTimer = function() {
        pauseTimer();
        updateRoundDisplay();
    }

    window.skipRound = function() {
        if(currentRound < rounds.length - 1) {
            currentRound++;
            updateRoundDisplay();
        }
    }

    window.startTournament = function() {
        if(players.length < 2) return showMessage("Need 2+ players", true);
        tournamentStarted = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('endBtn').disabled = false;
        document.getElementById('majorToggle').disabled = true;
        updateRoundDisplay();
        startTimer();
        updatePlayerTable();
    }

    window.endTournament = function() {
        if(!confirm("End Tournament?")) return;
        tournamentEnded = true;
        pauseTimer();
        document.getElementById('endBtn').disabled = true;
        document.getElementById('exportBtn').disabled = false;
        document.getElementById('majorToggle').disabled = false;
        updatePlayerTable();
    }

    window.clearPlayers = function() {
        if(tournamentStarted && !confirm("Clear all players?")) return;
        players = [];
        tournamentStarted = false;
        tournamentEnded = false;
        resetTimer();
        updatePlayerTable();
    }

    function recordAction(type, data) {
        actionHistory.push({ type, data });
        document.getElementById('undoBtn').disabled = false;
    }

    window.undoLastAction = function() {
        if(!actionHistory.length) return;
        alert("Undo is limited. Please manually correct.");
        actionHistory.pop();
        if(!actionHistory.length) document.getElementById('undoBtn').disabled = true;
    }

    // === API & DASHBOARD ===
    function initClient() {
        gapi.client.init({
            clientId: CLIENT_ID,
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            scope: SCOPES
        }).then(() => { googleApiReady = true; });
    }

    window.signInAndExport = function() {
        if(!googleApiReady) {
            // Try to recover
            gapi.load('client:auth2', () => {
                initClient();
                setTimeout(() => {
                    if(googleApiReady) gapi.auth2.getAuthInstance().signIn().then(exportData);
                    else alert("API failed to load. Refresh page.");
                }, 1000);
            });
            return;
        }
        gapi.auth2.getAuthInstance().signIn().then(exportData);
    }

    function exportData() {
        const toggle = document.getElementById('majorToggle');
        const isMajor = toggle && toggle.checked;
        const tName = document.getElementById('tournamentNameSelect').value;
        const date = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString();
        const tID = `${date}_${time.replace(/:/g,'-')}`;
        
        const active = players.filter(p => !p.eliminated);
        const elim = players.filter(p => p.eliminated).sort((a,b) => b.eliminationTime - a.eliminationTime);
        const finalOrder = [...active, ...elim];
        
        const rows = players.map(p => {
            const rank = finalOrder.findIndex(f => f.name === p.name) + 1;
            return [
                date, time, tID, p.name, rank, players.length, 
                p.totalPaid, 0, p.stacks - 1, p.hasAddon?1:0, 0, 
                p.eliminatedBy || 'N/A', tName, isMajor?"TRUE":"FALSE"
            ];
        });

        gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'PlayerResults!A:N',
            valueInputOption: 'USER_ENTERED',
            resource: { values: rows }
        }).then(() => showMessage("Saved!"));
    }

    window.signInAndLoadDashboard = function() {
        const btn = document.getElementById('loadDashboardBtn');
        if(!googleApiReady) {
            btn.innerText = "Connecting...";
            gapi.load('client:auth2', () => {
                initClient();
                setTimeout(() => {
                    if(googleApiReady) {
                        btn.innerText = "Load Dashboard";
                        gapi.auth2.getAuthInstance().signIn().then(loadDashboard);
                    } else {
                        alert("API not ready. Check internet or refresh.");
                        btn.innerText = "Load Dashboard";
                    }
                }, 1500);
            });
            return;
        }
        gapi.auth2.getAuthInstance().signIn().then(loadDashboard);
    }

    function loadDashboard() {
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: 'PlayerResults!A:N'
        }).then(resp => {
            const rows = resp.result.values || [];
            
            // Sync history players
            const histNames = new Set();
            rows.slice(1).forEach(r => { if(r[3]) histNames.add(r[3].trim()); });
            histNames.forEach(n => {
                if(!regularPlayers.includes(n) && !customPlayers.includes(n)) customPlayers.push(n);
            });
            populatePlayerDropdown();

            buildDashboard(rows);
            showMessage("Dashboard Loaded");
        });
    }

    function buildDashboard(rows) {
        const section = document.getElementById('chartsSection');
        const rows2026 = rows.filter((r, i) => i === 0 || r[0].startsWith('2026'));
        
        const stats2026 = calculate2026Points(rows2026);
        const detail2026 = calculateDetailedStats(rows2026);
        const allTime = calculateAllTime(rows);
        const titles = calculateTitles(detail2026);

        section.innerHTML = `
            <div class="dashboard-tabs">
                <button class="dashboard-tab active" onclick="switchTab('p2026')">üìä 2026 Leaderboard</button>
                <button class="dashboard-tab" onclick="switchTab('titles')">üèÜ Titles (2026)</button>
                <button class="dashboard-tab" onclick="switchTab('detailed')">üìà Detailed Stats (2026)</button>
                <button class="dashboard-tab" onclick="switchTab('alltime')">üìÖ All-Time Overview</button>
            </div>
            <div id="p2026" class="dashboard-tab-content">${render2026Leaderboard(stats2026)}</div>
            <div id="titles" class="dashboard-tab-content" style="display:none">${renderTitles(titles)}</div>
            <div id="detailed" class="dashboard-tab-content" style="display:none">${renderDetailed(detail2026)}</div>
            <div id="alltime" class="dashboard-tab-content" style="display:none">
                <p style="color:red; font-weight:bold; text-align:center;">‚ö†Ô∏è Note: 2025 data is incomplete.</p>
                ${renderAllTime(allTime)}
            </div>
        `;
    }

    window.switchTab = function(id) {
        document.querySelectorAll('.dashboard-tab-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.dashboard-tab').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.target.classList.add('active');
    }

    // --- STATS LOGIC ---
    function calculate2026Points(rows) {
        const tournaments = {}; 
        const stats = {};
        
        rows.slice(1).forEach(r => {
            const [d, t, tid, name, rankStr, f, paid, earn, rebuy, addon, roi, killer, tname, isMaj] = r;
            const isMajor = isMaj === 'TRUE';
            const rank = parseInt(rankStr);
            const multiplier = isMajor ? 2 : 1;

            if(!stats[name]) stats[name] = { points:0, wins:0, seconds:0, thirds:0, att:0, killerWins:0 };
            
            stats[name].att++;
            stats[name].points += (1 * multiplier); 

            if(rank === 1) { stats[name].points += (10 * multiplier); stats[name].wins++; }
            if(rank === 2) { stats[name].points += (7 * multiplier); stats[name].seconds++; }
            if(rank === 3) { stats[name].points += (4 * multiplier); stats[name].thirds++; }
            
            if(!tournaments[tid]) tournaments[tid] = { kills: {}, isMajor, ranks: {} };
            tournaments[tid].ranks[name] = rank;
            
            if(killer && killer !== 'N/A') {
                tournaments[tid].kills[killer] = (tournaments[tid].kills[killer] || 0) + 1;
            }
        });

        // Killer Bonus Logic (Only if killer rank >= 3)
        Object.values(tournaments).forEach(t => {
            const mult = t.isMajor ? 2 : 1;
            const eligibleKillers = [];
            
            Object.keys(t.kills).forEach(k => {
                const rk = t.ranks[k];
                if(rk && rk >= 3) eligibleKillers.push({ name: k, count: t.kills[k] });
            });
            
            if(eligibleKillers.length > 0) {
                eligibleKillers.sort((a,b) => b.count - a.count);
                const max = eligibleKillers[0].count;
                eligibleKillers.forEach(ek => {
                    if(ek.count === max && stats[ek.name]) {
                        stats[ek.name].points += (2 * mult);
                        stats[ek.name].killerWins++;
                    }
                });
            }
        });
        return Object.entries(stats).sort((a,b) => b[1].points - a[1].points);
    }

    function calculateDetailedStats(rows) {
        const s = {};
        rows.slice(1).forEach(r => {
            const [d,t,id,name,rankStr,field,paid,earn,rebuy,addon,roi,killer] = r;
            const rank = parseInt(rankStr);
            
            if(!s[name]) s[name] = { played:0, wins:0, sec:0, third:0, rebuys:0, addons:0, kills:0, deaths:0 };
            
            s[name].played++;
            s[name].rebuys += parseInt(rebuy)||0;
            s[name].addons += parseInt(addon)||0;
            
            if(rank === 1) s[name].wins++;
            if(rank === 2) s[name].sec++;
            if(rank === 3) s[name].third++;
            if(rank > 1) s[name].deaths++;
            
            if(killer && killer !== 'N/A') {
                if(!s[killer]) s[killer] = { played:0, wins:0, sec:0, third:0, rebuys:0, addons:0, kills:0, deaths:0 };
                s[killer].kills++;
            }
        });
        
        return Object.entries(s).map(([name, d]) => {
            d.winRate = d.played > 0 ? ((d.wins / d.played)*100).toFixed(0) + '%' : '0%';
            d.cashRate = d.played > 0 ? (((d.wins + d.sec)/d.played)*100).toFixed(0) + '%' : '0%';
            return [name, d];
        });
    }

    function calculateAllTime(rows) {
        const s = {};
        rows.slice(1).forEach(r => {
            const name = r[3];
            const rank = parseInt(r[4]);
            if(!s[name]) s[name] = { played:0, wins:0, sec:0, third:0, kills:0 };
            s[name].played++;
            if(rank===1) s[name].wins++;
            if(rank===2) s[name].sec++;
            if(rank===3) s[name].third++;
            if(r[11] && r[11]!=='N/A') {
                if(!s[r[11]]) s[r[11]] = { played:0, wins:0, sec:0, third:0, kills:0 };
                s[r[11]].kills++;
            }
        });
        return Object.entries(s).sort((a,b) => b[1].wins - a[1].wins);
    }
    
    function calculateTitles(statsArray) {
        // statsArray is [ [name, obj], ... ]
        // Simplified Titles Logic
        let maxK = {n:'', v:-1}, maxR = {n:'', v:-1}, max3 = {n:'', v:-1};
        
        statsArray.forEach(([n, d]) => {
            if(d.kills > maxK.v) maxK = {n:n, v:d.kills};
            if(d.rebuys > maxR.v) maxR = {n:n, v:d.rebuys};
            if(d.third > max3.v) max3 = {n:n, v:d.third};
        });
        return { killer: maxK, phoenix: maxR, bubble: max3 };
    }

    function render2026Leaderboard(data) {
        return `
            <div style="background:#ffcc80; padding:10px; text-align:center; font-weight:bold; margin-bottom:10px; border-radius:5px;">
                Points: 1st(10), 2nd(7), 3rd(4) | Att(+1). <br>
                Killer Bonus (+2) ONLY if finishing 3rd or lower. <br>
                MAJORS DOUBLE ALL POINTS!
            </div>
            <table>
                <thead><tr><th>Rank</th><th>Player</th><th>Points</th><th>1st</th><th>2nd</th><th>3rd</th><th>Att</th><th>Killer Wins</th></tr></thead>
                <tbody>${data.map((p, i) => `<tr><td>#${i+1}</td><td><strong>${p[0]}</strong></td><td style="color:#d84315; font-weight:bold;">${p[1].points}</td><td>${p[1].wins}</td><td>${p[1].seconds}</td><td>${p[1].thirds}</td><td>${p[1].att}</td><td>${p[1].killerWins}</td></tr>`).join('')}</tbody>
            </table>`;
    }

    function renderDetailed(data) {
        return `<table><thead><tr><th>Player</th><th>Games</th><th>1st</th><th>2nd</th><th>3rd</th><th>Kills</th><th>Deaths</th><th>Rebuys</th><th>Addons</th><th>Win%</th><th>Cash%</th></tr></thead><tbody>
        ${data.map(p => `<tr><td><strong>${p[0]}</strong></td><td>${p[1].played}</td><td>${p[1].wins}</td><td>${p[1].sec}</td><td>${p[1].third}</td><td>${p[1].kills}</td><td>${p[1].deaths}</td><td>${p[1].rebuys}</td><td>${p[1].addons}</td><td>${p[1].winRate}</td><td>${p[1].cashRate}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderAllTime(data) {
        return `<table><thead><tr><th>Rank</th><th>Player</th><th>ü•á Wins</th><th>ü•à 2nd</th><th>3rd</th><th>Games</th><th>Kills</th></tr></thead><tbody>
        ${data.map((p,i) => `<tr><td>${i+1}</td><td>${p[0]}</td><td>${p[1].wins}</td><td>${p[1].sec}</td><td>${p[1].third}</td><td>${p[1].played}</td><td>${p[1].kills}</td></tr>`).join('')}</tbody></table>`;
    }
    
    function renderTitles(t) {
        return `<div class="titles-grid">
            <div class="title-card"><span class="title-card-emoji">üíÄ</span><div class="title-card-name">The Killer</div><div class="title-card-holder">${t.killer.n}</div><div class="title-card-stat">${t.killer.v} Kills</div></div>
            <div class="title-card"><span class="title-card-emoji">üî•</span><div class="title-card-name">The Phoenix</div><div class="title-card-holder">${t.phoenix.n}</div><div class="title-card-stat">${t.phoenix.v} Rebuys</div></div>
            <div class="title-card"><span class="title-card-emoji">ü´ß</span><div class="title-card-name">Bubble Boy</div><div class="title-card-holder">${t.bubble.n}</div><div class="title-card-stat">${t.bubble.v} 3rd Places</div></div>
        </div>`;
    }

    // Utility
    function formatTime(s) {
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return `${m}:${sec<10?'0'+sec:sec}`;
    }
    function showMessage(msg, isErr) {
        const el = document.getElementById('statusMessage');
        el.innerText = msg;
        el.style.backgroundColor = isErr ? '#ffebee' : '#e8f5e8';
        el.style.color = isErr ? '#c62828' : '#2e7d32';
        el.className = 'status-message show';
        setTimeout(() => el.className = 'status-message', 3000);
    }
  </script>
</body>
</html>