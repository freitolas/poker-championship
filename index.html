<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Texas Hold'em Championship Manager</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #fff7e1 0%, #ffe0b2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #7a4800;
      display: flex;
      min-height: 100vh;
    }
    
    .main-content {
      flex: 3;
      padding: 20px;
      min-width: 500px;
      overflow-y: auto;
    }
    
    h1 {
      text-align: center;
      color: #e65100;
      font-size: 2.2rem;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .game-info {
      background: linear-gradient(90deg, #ffd740 0%, #ffa726 100%);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      color: #d84315;
      font-weight: 700;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
    }
    
    .player-setup {
      background: #fff3e0;
      padding: 20px;
      border: 2px solid #ffa726;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
    }
    
    .player-setup h3 {
      margin-top: 0;
      color: #e65100;
      font-size: 1.4rem;
    }
    
    .player-input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    #playerNameInput {
      flex: 1;
      padding: 10px;
      border: 2px solid #ffa726;
      border-radius: 6px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    
    #playerNameInput:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
    }
    
    .setup-buttons {
      display: flex;
      gap: 12px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    button {
      padding: 10px 16px;
      border: 2px solid #ffa726;
      border-radius: 6px;
      background: #ffb74d;
      color: #7a4800;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    button:hover:not(:disabled) {
      background: #ff9800;
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(255, 152, 0, 0.3);
    }
    
    button:disabled {
      background: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
      border-color: #bdbdbd;
      transform: none;
      box-shadow: none;
    }
    
    .rebuy-btn {
      background: #f44336 !important;
      color: white !important;
      border-color: #d32f2f !important;
    }
    
    .rebuy-btn:hover:not(:disabled) {
      background: #d32f2f !important;
    }
    
    .addon-btn {
      background: #2196f3 !important;
      color: white !important;
      border-color: #1976d2 !important;
    }
    
    .addon-btn:hover:not(:disabled) {
      background: #1976d2 !important;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    #playerCount {
      text-align: center;
      font-weight: 600;
      color: #e65100;
      margin: 10px 0;
      font-size: 1.1rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff3e0;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
      margin-bottom: 20px;
    }
    
    th, td {
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
    }
    
    thead {
      background: linear-gradient(90deg, #ff9800 0%, #fb8c00 100%);
      color: white;
    }
    
    tbody tr:nth-child(odd) {
      background: #fff9e5;
    }
    
    tbody tr:nth-child(even) {
      background: #fff3e0;
    }
    
    tbody tr.eliminated {
      background: #ffcdd2 !important;
      color: #c62828;
      opacity: 0.8;
    }
    
    .timer-panel {
      flex: 1;
      background: linear-gradient(135deg, #ffecb3 0%, #ffd54f 100%);
      border-left: 7px solid #ffa726;
      box-shadow: -2px 0 14px rgba(255, 152, 0, 0.13);
      padding: 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      position: sticky;
      top: 0;
      overflow-y: auto;
    }
    
    .timer-header {
      font-size: 2.4rem;
      font-weight: 900;
      color: #e65100;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .round-info {
      width: 100%;
      background: #ffe0b2;
      border-radius: 12px;
      padding: 20px;
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
      color: #e65100;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
    }
    
    .blind-display {
      background: #ffd54f;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 1.6rem;
      color: #e65100;
      margin: 10px 0;
      font-weight: 800;
    }
    
    .time-remaining {
      font-size: 3.8rem;
      font-weight: 900;
      background: #ffd54f;
      color: #e65100;
      border-radius: 15px;
      padding: 20px 35px;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.25);
      margin: 20px 0 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      min-width: 200px;
      text-align: center;
    }
    
    .timer-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .timer-controls button {
      min-width: 80px;
    }
    
    .break-notice, .final-stage {
      display: none;
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: 700;
      margin: 15px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .break-notice {
      background: #bbdefb;
      color: #0d47a1;
      border: 2px solid #2196f3;
    }
    
    .final-stage {
      background: #ffecb3;
      color: #e65100;
      border: 2px solid #ffa726;
    }
    
    .prize-info {
      background: #fff3e0;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      color: #e65100;
      margin-top: 20px;
      width: 100%;
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
    }
    
    .prize-info div {
      margin: 8px 0;
      font-size: 1.1rem;
    }
    
    .prize-info div:first-child {
      font-size: 1.3rem;
      font-weight: 800;
    }
    
    .charts-section {
      margin-top: 30px;
    }
    
    .charts-section h3 {
      color: #e65100;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .status-message, .error-message {
      background: #e8f5e8;
      border: 2px solid #4caf50;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
      height: 20px;
      min-height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .error-message {
      background: #ffebee;
      border: 2px solid #f44336;
      color: #c62828;
    }
    
    .status-message.show, .error-message.show {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .main-content {
        min-width: auto;
      }
      
      .timer-panel {
        height: auto;
        position: relative;
      }
      
      .timer-header {
        font-size: 2rem;
      }
      
      .time-remaining {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <h1>Texas Hold'em Championship Manager</h1>
    
    <div class="game-info">
      Buy-in: £5 per stack | 1st: 80% | 2nd: 20% | House Fee: £5 (£10 if pot &gt; £100)
    </div>
    
    <div class="status-message" id="statusMessage"></div>
    <div class="error-message" id="errorMessage"></div>
    
    <div class="player-setup">
      <h3>Add Players</h3>
      <div class="player-input-row">
        <select id="playerSelect" style="flex: 1; padding: 8px; border: 2px solid #ffa726; border-radius: 6px; font-size: 16px; margin-right: 10px;">
          <option value="">Select a player...</option>
        </select>
        <input type="text" id="playerNameInput" placeholder="Or enter new player name..." style="flex: 1; padding: 8px; border: 2px solid #ffa726; border-radius: 6px; font-size: 16px; margin-right: 10px;" />
        <button onclick="addPlayer()">Add Player</button>
      </div>
      
      <div class="setup-buttons">
        <button onclick="startTournament()" id="startBtn">Start Tournament</button>
        <button onclick="endTournament()" id="endBtn" disabled>End Tournament</button>
        <button onclick="clearPlayers()">Clear All Players</button>
        <button onclick="undoLastAction()" id="undoBtn" disabled>Undo</button>
      </div>
      
      <div id="playerCount">Players: 0 | Prize Pot: £0 | House Fee: £5</div>
      
      <div class="action-buttons">
        <button onclick="signInAndExport()" id="exportBtn" disabled>Save Tournament Data</button>
        <button onclick="signInAndLoadDashboard()" id="loadDashboardBtn" disabled>Load Championship Dashboard</button>
      </div>
    </div>
    
    <table id="playerTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Stacks</th>
          <th>Total Paid</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="playerTableBody"></tbody>
    </table>
    
    <div id="prizeResults"></div>
    <div class="charts-section" id="chartsSection"></div>
  </div>
  
  <div class="timer-panel">
    <div class="timer-header">ROUND TIMER</div>
    <div id="roundInfo" class="round-info">Test Round<br><span class="blind-display">TEST ROUND</span><div style="font-size: 1.1rem; margin-top: 10px;">Duration: 5 seconds</div></div>
    <div id="timeRemaining" class="time-remaining">00:05</div>
    
    <div class="timer-controls">
      <button id="timerStartBtn" onclick="startTimer()">START</button>
      <button id="timerPauseBtn" onclick="pauseTimer()" disabled>PAUSE</button>
      <button id="timerResetBtn" onclick="resetTimer()">RESET</button>
      <button id="timerSkipBtn" onclick="skipRound()">SKIP ROUND</button>
    </div>
    
    <div id="breakNotice" class="break-notice">
      <strong>BREAK TIME!</strong><br>30 minutes - Add-ons available
    </div>
    
    <div id="finalStage" class="final-stage">
      <strong>FINAL STAGE</strong><br>No more re-buys or add-ons
    </div>
    
    <div class="prize-info">
      <div><strong>Current Prize Pool: £<span id="currentPrizePool">0</span></strong></div>
      <div>1st Place: £<span id="firstPrize">0</span></div>
      <div>2nd Place: £<span id="secondPrize">0</span></div>
    </div>
  </div>

  <script>
    console.log('Texas Hold\'em Championship Manager - Starting...');

    // Configuration
    const CLIENT_ID = '341648594146-a9httcsv8e29vr4ehcup08qlpaak5u8a.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1fZWOlbf95Xqg4AnsEm9ga8x1ENrZ_K_0EEF3sEZGz2Y';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    // Tournament structure
    const tournamentRounds = [
      { name: "Test Round", sb: 0, bb: 0, duration: 5, isTest: true },
      { name: "Round 1", sb: 5, bb: 10, duration: 20 },
      { name: "Round 2", sb: 10, bb: 20, duration: 20 },
      { name: "Round 3", sb: 20, bb: 40, duration: 20 },
      { name: "Round 4", sb: 40, bb: 80, duration: 20 },
      { name: "Break + Add-On", sb: 0, bb: 0, duration: 30, isBreak: true },
      { name: "Round 5", sb: 50, bb: 100, duration: 20 },
      { name: "Round 6", sb: 100, bb: 200, duration: 20 },
      { name: "Round 7", sb: 200, bb: 400, duration: 20 },
      { name: "Round 8", sb: 400, bb: 800, duration: 20 },
      { name: "Round 9", sb: 1000, bb: 2000, duration: 20 }
    ];

    // Pre-populated player list
    const regularPlayerList = [
      'Andre', 'Craig', 'Dale', 'Declan', 'Elton', 'Graham', 'Jacques', 'James', 'Lachy', 'Luciano', 'Malzo', 'Matt', 'Nick', 'Rafa', 'Rhys', 'Roberto'
    ].sort();

    // Global state variables
    let tournamentPlayers = [];
    let customPlayerList = [];
    let currentTournamentRound = 0;
    let roundTimer = null;
    let timeLeftInRound = 5;
    let isTournamentStarted = false;
    let isTournamentEnded = false;
    let isBreakTime = false;
    let isFinalTournamentStage = false;
    let isTimerRunning = false;
    let tournamentActionHistory = [];
    let isGoogleApiReady = false;

    console.log('All variables initialized successfully');

    // Utility functions
    function formatTimeDisplay(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function displayMessage(message, isError = false) {
      console.log((isError ? 'ERROR: ' : 'MESSAGE: ') + message);
      const statusElement = document.getElementById('statusMessage');
      const errorElement = document.getElementById('errorMessage');
      
      if (statusElement) statusElement.classList.remove('show');
      if (errorElement) errorElement.classList.remove('show');
      
      setTimeout(() => {
        if (isError && errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add('show');
        } else if (!isError && statusElement) {
          statusElement.textContent = message;
          statusElement.classList.add('show');
        }
        
        setTimeout(() => {
          if (statusElement) statusElement.classList.remove('show');
          if (errorElement) errorElement.classList.remove('show');
        }, 3000);
      }, 10);
    }

    // Google Sheets Integration
    function initializeGoogleAPI() {
      try {
        console.log('Initializing Google API...');
        
        if (window.google && window.google.accounts) {
          console.log('Using Google Identity Services');
          setupGoogleIdentityServices();
        } else {
          console.log('Using legacy Google API');
          if (typeof gapi !== 'undefined') {
            gapi.load('client:auth2', {
              callback: setupLegacyGoogleAPI,
              onerror: function(error) {
                console.log('Google API load failed:', error);
                enableGoogleAPIFallback();
              }
            });
          } else {
            enableGoogleAPIFallback();
          }
        }
      } catch (error) {
        console.log('Google API initialization failed:', error);
        enableGoogleAPIFallback();
      }
    }

    function setupGoogleIdentityServices() {
      try {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: handleGoogleCredentialResponse
        });

        gapi.load('client', () => {
          gapi.client.init({
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
          }).then(() => {
            console.log('Google Identity Services initialized successfully');
            isGoogleApiReady = true;
            
            window.googleTokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (response) => {
                if (response.access_token) {
                  gapi.client.setToken(response);
                  updateGoogleSigninStatus(true);
                }
              }
            });
            
            updateGoogleSigninStatus(false);
          }).catch(error => {
            console.log('GIS client init failed:', error);
            enableGoogleAPIFallback();
          });
        });
      } catch (error) {
        console.log('GIS initialization failed:', error);
        enableGoogleAPIFallback();
      }
    }

    function handleGoogleCredentialResponse(response) {
      console.log('Google credential response received');
    }

    function enableGoogleAPIFallback() {
      console.log('Google Sheets integration disabled - using fallback mode');
      isGoogleApiReady = false;
    }

    function setupLegacyGoogleAPI() {
      try {
        return gapi.client.init({
          apiKey: '',
          clientId: CLIENT_ID,
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
          scope: SCOPES
        }).then(() => {
          console.log('Legacy Google API initialized successfully');
          isGoogleApiReady = true;
          const authInstance = gapi.auth2.getAuthInstance();
          updateGoogleSigninStatus(authInstance.isSignedIn.get());
          authInstance.isSignedIn.listen(updateGoogleSigninStatus);
        }).catch(error => {
          console.log('Legacy Google API init failed:', error);
          enableGoogleAPIFallback();
        });
      } catch (error) {
        console.log('Legacy Google API setup failed:', error);
        enableGoogleAPIFallback();
      }
    }

    function updateGoogleSigninStatus(isSignedIn) {
      const exportButton = document.getElementById('exportBtn');
      const dashboardButton = document.getElementById('loadDashboardBtn');
      
      if (isTournamentEnded && isGoogleApiReady) {
        exportButton.disabled = false;
        dashboardButton.disabled = false;
        
        if (isSignedIn) {
          exportButton.textContent = 'Save Tournament Data';
          dashboardButton.textContent = 'Load Championship Dashboard';
        } else {
          exportButton.textContent = 'Sign in to Save';
          dashboardButton.textContent = 'Sign in to Load Dashboard';
        }
      } else {
        exportButton.disabled = true;
        dashboardButton.disabled = true;
        
        if (!isTournamentEnded) {
          exportButton.textContent = 'End Tournament First';
          dashboardButton.textContent = 'End Tournament First';
        } else if (!isGoogleApiReady) {
          exportButton.textContent = 'Google API Loading...';
          dashboardButton.textContent = 'Google API Loading...';
        }
      }
    }

    // Player dropdown population
    function populatePlayerDropdown() {
      console.log('Populating player dropdown...');
      const dropdownElement = document.getElementById('playerSelect');
      if (!dropdownElement) return;
      
      dropdownElement.innerHTML = '<option value="">Select a player...</option>';
      
      regularPlayerList.forEach(playerName => {
        const optionElement = document.createElement('option');
        optionElement.value = playerName;
        optionElement.textContent = playerName;
        dropdownElement.appendChild(optionElement);
      });
      
      customPlayerList.forEach(playerName => {
        const optionElement = document.createElement('option');
        optionElement.value = playerName;
        optionElement.textContent = `${playerName} (New)`;
        dropdownElement.appendChild(optionElement);
      });
      
      console.log(`Dropdown populated with ${regularPlayerList.length} regular players`);
    }

    // Player management functions
    function addPlayer() {
      console.log('addPlayer function called');
      const inputElement = document.getElementById('playerNameInput');
      const dropdownElement = document.getElementById('playerSelect');
      
      let playerName = '';
      if (dropdownElement && dropdownElement.value) {
        playerName = dropdownElement.value;
      } else if (inputElement && inputElement.value) {
        playerName = inputElement.value.trim();
      }
      
      if (!playerName) {
        displayMessage('Please enter a player name or select from dropdown', true);
        return;
      }
      
      if (tournamentPlayers.some(p => p.name.toLowerCase() === playerName.toLowerCase())) {
        displayMessage('Player already exists in tournament', true);
        return;
      }
      
      if (isTournamentStarted) {
        displayMessage('Cannot add players after tournament has started', true);
        return;
      }
      
      tournamentPlayers.push({
        name: playerName,
        stacks: 1,
        totalPaid: 5,
        eliminated: false,
        hasAddon: false,
        eliminationTime: null
      });
      
      if (inputElement) inputElement.value = '';
      if (dropdownElement) dropdownElement.value = '';
      
      if (!regularPlayerList.includes(playerName) && !customPlayerList.includes(playerName)) {
        customPlayerList.push(playerName);
        populatePlayerDropdown();
      }
      
      if (inputElement) inputElement.focus();
      
      updatePlayerTable();
      displayMessage(`${playerName} added to tournament`);
    }

    function removePlayer(index) {
      if (isTournamentStarted) {
        displayMessage('Cannot remove players after tournament has started', true);
        return;
      }
      
      const playerName = tournamentPlayers[index].name;
      tournamentPlayers.splice(index, 1);
      updatePlayerTable();
      displayMessage(`${playerName} removed from tournament`);
    }

    function eliminatePlayer(index) {
      if (!isTournamentStarted || isTournamentEnded) return;
      
      const player = tournamentPlayers[index];
      player.eliminationTime = Date.now();
      player.eliminated = true;
      
      const remainingActivePlayers = tournamentPlayers.filter(p => !p.eliminated).length;
      const finishPosition = remainingActivePlayers + 1;
      
      updatePlayerTable();
      displayMessage(`${player.name} eliminated (${finishPosition}${getOrdinalSuffix(finishPosition)} place)`);
    }

    function getOrdinalSuffix(number) {
      if (number % 10 === 1 && number % 100 !== 11) return 'st';
      if (number % 10 === 2 && number % 100 !== 12) return 'nd';
      if (number % 10 === 3 && number % 100 !== 13) return 'rd';
      return 'th';
    }

    function rebuyPlayer(index) {
      if (isTournamentEnded || isFinalTournamentStage) {
        displayMessage('Re-buys not available in final stage', true);
        return;
      }
      
      const player = tournamentPlayers[index];
      if (!player.eliminated) {
        displayMessage('Player must be eliminated to re-buy', true);
        return;
      }
      
      player.eliminated = false;
      player.stacks++;
      player.totalPaid += 5;
      updatePlayerTable();
      displayMessage(`${player.name} re-bought for £5`);
    }

    function addonPlayer(index) {
      if (!isBreakTime || isTournamentEnded || isFinalTournamentStage) {
        displayMessage('Add-ons only available during breaks', true);
        return;
      }
      
      const player = tournamentPlayers[index];
      if (player.hasAddon) {
        displayMessage('Player already used their add-on', true);
        return;
      }
      
      player.stacks++;
      player.totalPaid += 5;
      player.hasAddon = true;
      updatePlayerTable();
      displayMessage(`${player.name} purchased add-on for £5`);
    }

    function clearPlayers() {
      if (isTournamentStarted && !isTournamentEnded) {
        if (!confirm('Tournament is in progress. Clear all players?')) {
          return;
        }
      }
      
      tournamentPlayers = [];
      isTournamentStarted = false;
      isTournamentEnded = false;
      resetTournament();
      updatePlayerTable();
      displayMessage('All players cleared');
    }

    // Tournament management functions
    function startTournament() {
      if (tournamentPlayers.length < 2) {
        displayMessage('Need at least 2 players to start tournament', true);
        return;
      }
      
      isTournamentStarted = true;
      isTournamentEnded = false;
      
      document.getElementById('startBtn').disabled = true;
      document.getElementById('endBtn').disabled = false;
      document.getElementById('exportBtn').disabled = true;
      document.getElementById('loadDashboardBtn').disabled = true;
      
      currentTournamentRound = 0;
      updateRoundDisplay();
      
      updatePlayerTable();
      displayMessage('Tournament started!');
    }

    function endTournament() {
      if (!confirm('Are you sure you want to end the tournament?')) return;
      
      isTournamentEnded = true;
      isTournamentStarted = false;
      clearInterval(roundTimer);
      isTimerRunning = false;
      
      document.getElementById('endBtn').disabled = true;
      document.getElementById('timerStartBtn').disabled = true;
      document.getElementById('timerPauseBtn').disabled = true;
      